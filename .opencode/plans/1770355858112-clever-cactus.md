# Plan: Install Tailscale with SSH Support (using supervisord)

## Summary
Add Tailscale VPN with SSH support to the Railway deployment using supervisord for process management. This enables secure remote SSH access and provides a foundation for adding more supervised services in the future.

## Files to Modify/Create

| File | Action |
|------|--------|
| `Dockerfile` | Modify - Install Tailscale + supervisord |
| `docker/supervisord.conf` | Create - Supervisor configuration |
| `docker/tailscale-up.sh` | Create - Tailscale connection script |

## Implementation Details

### 1. Create Supervisor Configuration
**File:** `docker/supervisord.conf`

```ini
[supervisord]
nodaemon=true
logfile=/var/log/supervisord.log
pidfile=/var/run/supervisord.pid
user=root

[program:tailscaled]
command=/usr/sbin/tailscaled --state=/data/tailscale/state --tun=userspace-networking
autostart=true
autorestart=true
priority=10
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

[program:tailscale-up]
command=/app/docker/tailscale-up.sh
autostart=true
autorestart=false
startsecs=0
priority=20
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

[program:app]
command=node src/server.js
directory=/app
autostart=true
autorestart=true
priority=30
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
```

### 2. Create Tailscale Connection Script
**File:** `docker/tailscale-up.sh`

```bash
#!/bin/bash
set -e

# Wait for tailscaled to be ready
sleep 3

# Create state directory
mkdir -p /data/tailscale

# Connect to Tailscale if auth key is provided
if [ -n "$TAILSCALE_AUTHKEY" ]; then
    tailscale up \
        --authkey="$TAILSCALE_AUTHKEY" \
        --ssh \
        --hostname="${TAILSCALE_HOSTNAME:-railway-openclaw}"
    echo "Tailscale connected successfully"
else
    echo "TAILSCALE_AUTHKEY not set, skipping Tailscale connection"
fi
```

### 3. Modify Dockerfile
**File:** `Dockerfile`

**Add to apt-get install block (line ~47):**
```dockerfile
    supervisor \
```

**Add after apt-get block (after line 55):**
```dockerfile
# Install Tailscale
RUN curl -fsSL https://tailscale.com/install.sh | sh

# Create Tailscale state directory
RUN mkdir -p /data/tailscale
```

**Add before final CMD (after line 120):**
```dockerfile
# Copy supervisor config and scripts
COPY docker/supervisord.conf /etc/supervisor/conf.d/supervisord.conf
COPY docker/tailscale-up.sh /app/docker/tailscale-up.sh
RUN chmod +x /app/docker/tailscale-up.sh
```

**Change CMD (line 126):**
```dockerfile
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
```

## Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `TAILSCALE_AUTHKEY` | Yes | Tailscale auth key (generate at admin console) |
| `TAILSCALE_HOSTNAME` | No | Custom hostname (default: `railway-openclaw`) |

## Usage

1. Generate an auth key at https://login.tailscale.com/admin/settings/keys
   - Recommend: Reusable key with tag for identification
2. Set `TAILSCALE_AUTHKEY` in Railway environment variables
3. Deploy - container will connect to Tailscale and enable SSH

## SSH Access

```bash
ssh root@railway-openclaw  # or your custom hostname
```

Tailscale SSH uses your Tailscale identity for authentication.

## Adding Future Services

To add more services, edit `docker/supervisord.conf`:

```ini
[program:my-new-service]
command=/path/to/service
autostart=true
autorestart=true
priority=40
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
```

## Verification

1. Check container logs for supervisord output
2. SSH into container and run `tailscale status`
3. Run `supervisorctl status` to check all services
