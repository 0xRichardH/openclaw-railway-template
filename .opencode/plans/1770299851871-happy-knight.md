# Plan: Add mise runtime with bun, opencode, codex, claude-code

## Goal
Add mise to the runtime Docker image and use it to install bun, opencode-ai, @openai/codex, and @anthropic-ai/claude-code at build time. Tools should be available on PATH for the runtime process.

## Key Decisions
- **Config location**: `mise.toml` at repo root (copied into image at `/root/mise.toml`)
- **Install timing**: Build time (baked into image)
- **Runtime user**: root (current image uses root)
- **Version strategy**: Keep `latest`/`stable` as specified by user
- **PATH strategy**: Global PATH shims so subprocesses can find tools

## Files to Modify

### 1. `mise.toml` (new file)
Create at repo root with the following content:
```toml
[settings]
npm.bun = true

[tools]
bun = "latest"
"npm:opencode-ai" = "latest"
"npm:@openai/codex" = "latest"
"npm:@anthropic-ai/claude-code" = "stable"
```

### 2. `Dockerfile` (runtime stage)

**After line 48** (after `rm -rf /var/lib/apt/lists/*`), add:
```dockerfile
# Install mise and required dependencies
RUN apt-get update \
  && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    curl \
    git \
    xz-utils \
  && rm -rf /var/lib/apt/lists/*

# Install mise
RUN curl -fsSL https://mise.run | sh
ENV PATH="/root/.local/bin:${PATH}"
ENV MISE_CONFIG_DIR="/root"
ENV MISE_GLOBAL_CONFIG_FILE="/root/mise.toml"

# Copy mise config and install tools
COPY mise.toml /root/mise.toml
RUN mise install \
  && mise reshim \
  && mise exec -- bun --version \
  && mise exec -- opencode --version \
  && mise exec -- codex --version \
  && mise exec -- claude --version

# Ensure mise shims are on PATH for runtime
ENV PATH="/root/.local/share/mise/shims:${PATH}"
```

## Verification Steps

1. Build the image:
   ```bash
   docker build -t openclaw-railway-template:mise .
   ```

2. Verify tools are installed:
   ```bash
   docker run --rm openclaw-railway-template:mise mise --version
   docker run --rm openclaw-railway-template:mise bun --version
   docker run --rm openclaw-railway-template:mise opencode --version
   docker run --rm openclaw-railway-template:mise codex --version
   docker run --rm openclaw-railway-template:mise claude --version
   ```

3. Verify server still starts:
   ```bash
   docker run --rm -p 8080:8080 \
     -e PORT=8080 \
     -e SETUP_PASSWORD=test \
     openclaw-railway-template:mise
   ```

4. Run CI build check:
   ```bash
   docker build -t openclaw-railway-template:ci .
   ```

## Risks & Considerations
- **Image size**: Will increase due to mise + toolchains
- **Build time**: Network dependency for mise downloads
- **Version drift**: Using `latest`/`stable` means builds may produce different images over time
- **PATH conflicts**: mise shims should not shadow system node (we keep system node as primary)
- **Tool dependencies**: Some tools may need additional OS packages; add as needed

## Rollback Plan
If issues arise, revert Dockerfile changes and remove mise.toml. The original runtime image will be restored.

---

# Plan: Add Homebrew on Linux to runtime image

## Goal
Install Homebrew on Linux in the Docker runtime image at `/home/linuxbrew/.linuxbrew` and use it to install common development tools.

## Key Decisions
- **Install location**: `/home/linuxbrew/.linuxbrew` (standard prefix, supports precompiled binaries)
- **Install timing**: Build time (baked into image)
- **Runtime user**: root (current image uses root)
- **Packages to install**: git, curl, wget, jq, yq, ripgrep, fd, fzf

## Files to Modify

### 1. `Dockerfile` (runtime stage)

**After the mise installation section (around line 69), add:**

```dockerfile
# Install Homebrew on Linux
# Required dependencies for Homebrew
RUN apt-get update \
  && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    build-essential \
    procps \
    curl \
    file \
    git \
  && rm -rf /var/lib/apt/lists/*

# Create linuxbrew user and install Homebrew
RUN useradd -m -s /bin/bash linuxbrew \
  && mkdir -p /home/linuxbrew/.linuxbrew \
  && chown -R linuxbrew:linuxbrew /home/linuxbrew

# Install Homebrew as linuxbrew user
USER linuxbrew
RUN /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# Add Homebrew to PATH for all users
ENV PATH="/home/linuxbrew/.linuxbrew/bin:/home/linuxbrew/.linuxbrew/sbin:${PATH}"

# Install common dev tools via Homebrew (as linuxbrew user)
USER linuxbrew
RUN brew install \
    wget \
    jq \
    yq \
    ripgrep \
    fd \
    fzf \
  && brew cleanup \
  && brew --version

# Switch back to root for remaining setup
USER root
```

## Verification Steps

1. Build the image:
   ```bash
   docker build -t openclaw-railway-template:homebrew .
   ```

2. Verify Homebrew is installed:
   ```bash
   docker run --rm openclaw-railway-template:homebrew brew --version
   ```

3. Verify Homebrew packages are installed:
   ```bash
   docker run --rm openclaw-railway-template:homebrew which git
   docker run --rm openclaw-railway-template:homebrew which curl
   docker run --rm openclaw-railway-template:homebrew which wget
   docker run --rm openclaw-railway-template:homebrew which jq
   docker run --rm openclaw-railway-template:homebrew which yq
   docker run --rm openclaw-railway-template:homebrew which rg
   docker run --rm openclaw-railway-template:homebrew which fd
   docker run --rm openclaw-railway-template:homebrew which fzf
   ```

4. Verify server still starts:
   ```bash
   docker run --rm -p 8080:8080 \
     -e PORT=8080 \
     -e SETUP_PASSWORD=test \
     openclaw-railway-template:homebrew
   ```

## Risks & Considerations
- **Image size**: Will significantly increase due to Homebrew + packages (~500MB-1GB)
- **Build time**: Network dependency for Homebrew installation and package downloads
- **User permissions**: Homebrew installed as `linuxbrew` user but available to root
- **Binary compatibility**: Using standard prefix ensures precompiled binaries work
- **Conflict with system packages**: Some tools (git, curl) may already be installed via apt

## Rollback Plan
If issues arise, revert Dockerfile changes. The original runtime image will be restored.

---

# Plan: Add agent-browser via mise

## Goal
Install agent-browser CLI tool using mise and run `agent-browser install --with-deps` to install Chromium and system dependencies.

## Key Decisions
- **Installation method**: Add `npm:agent-browser` to mise.toml
- **Version strategy**: Use `latest` for agent-browser
- **Dependencies**: Run `agent-browser install --with-deps` to install Chromium + Linux system deps
- **Branch**: Add to `feat/add-mise-runtime-tooling` branch (mise-related)

## Files to Modify

### 1. `docker/mise.toml`

Add agent-browser to the tools section:

```toml
[settings]
npm.bun = true

[tools]
bun = "latest"
"npm:opencode-ai" = "latest"
"npm:@openai/codex" = "latest"
"npm:@anthropic-ai/claude-code" = "stable"
"npm:agent-browser" = "latest"
```

### 2. `Dockerfile` (runtime stage)

After the mise install step (around line 65-70), add:

```dockerfile
# Install agent-browser dependencies (Chromium + system deps)
RUN mise exec -- agent-browser install --with-deps
```

## Verification Steps

1. Build the image:
   ```bash
   docker build -t openclaw-railway-template:agent-browser .
   ```

2. Verify agent-browser is installed:
   ```bash
   docker run --rm openclaw-railway-template:agent-browser agent-browser --version
   ```

3. Verify Chromium is installed:
   ```bash
   docker run --rm openclaw-railway-template:agent-browser agent-browser --help
   ```

4. Test basic functionality:
   ```bash
   docker run --rm openclaw-railway-template:agent-browser agent-browser open example.com
   docker run --rm openclaw-railway-template:agent-browser agent-browser snapshot
   docker run --rm openclaw-railway-template:agent-browser agent-browser close
   ```

5. Verify server still starts:
   ```bash
   docker run --rm -p 8080:8080 \
     -e PORT=8080 \
     -e SETUP_PASSWORD=test \
     openclaw-railway-template:agent-browser
   ```

## Risks & Considerations
- **Image size**: Will increase significantly due to Chromium (~300-400MB)
- **Build time**: `install --with-deps` downloads Chromium and installs apt packages
- **System dependencies**: Requires additional Linux packages (installed by `--with-deps`)
- **Headless mode**: Will run headless by default in Docker (no display)

## Rollback Plan
If issues arise, remove agent-browser from mise.toml and the Dockerfile RUN command.
